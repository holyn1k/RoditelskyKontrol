<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartKey: AI Family Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .view-section { display: none; flex-direction: column; }
        .view-section.active { display: flex; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Стили для активной кнопки сложности */
        .diff-btn.active { 
            background-color: #4f46e5 !important; 
            color: white !important; 
            border-color: #4f46e5 !important; 
            box-shadow: 0 4px 6px -1px rgb(79 70 229 / 0.2);
        }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
    <header class="p-4 flex justify-between items-center border-b bg-white z-20 shadow-sm">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-brain"></i>
            </div>
            <h1 class="font-extrabold text-indigo-900 tracking-tight uppercase">SmartKey AI</h1>
        </div>
        <div class="flex items-center gap-2">
            <div id="family-badge" class="hidden text-[10px] font-bold px-2 py-1 rounded bg-indigo-100 text-indigo-700 uppercase"></div>
            <button id="logout-btn" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="flex-1 relative p-6 overflow-y-auto">
        <div id="auth-error-msg" class="hidden p-4 mb-4 bg-red-50 text-red-600 text-xs rounded-xl border border-red-100">
            Ошибка конфигурации Firebase. Проверьте настройки.
        </div>

        <!-- РОЛИ -->
        <div id="view-role-selection" class="view-section active h-full justify-center gap-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">Кто зашел?</h2>
            </div>
            <button id="btn-role-parent" class="w-full p-6 border-2 border-indigo-100 rounded-3xl hover:border-indigo-500 flex items-center gap-4 text-left transition-all group">
                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-all"><i class="fas fa-user-shield"></i></div>
                <div><b class="block text-lg">Родитель</b><span class="text-xs text-slate-500">Настроить задачи и контроль</span></div>
            </button>
            <button id="btn-role-child" class="w-full p-6 border-2 border-orange-100 rounded-3xl hover:border-orange-500 flex items-center gap-4 text-left transition-all group">
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-all"><i class="fas fa-child"></i></div>
                <div><b class="block text-lg">Ребенок</b><span class="text-xs text-slate-500">Решить тест для входа</span></div>
            </button>
        </div>

        <!-- SETUP РОДИТЕЛЯ -->
        <div id="view-parent-setup" class="view-section space-y-6">
            <h2 class="text-xl font-bold text-slate-800">Ваш Семейный ID</h2>
            <div class="p-8 bg-indigo-50 rounded-[2rem] text-center border-2 border-indigo-100">
                <span id="display-family-id" class="text-4xl font-mono font-black text-indigo-600 tracking-[0.2em]">......</span>
            </div>
            <p class="text-sm text-slate-500 text-center px-4">Ребенок должен ввести этот ID при подключении к вашей семейной группе.</p>
            <button id="btn-parent-go" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-100 active:scale-95 transition-all">К НАСТРОЙКАМ ТЕСТА</button>
        </div>

        <!-- DASHBOARD РОДИТЕЛЯ -->
        <div id="view-parent-dash" class="view-section space-y-5">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-2 h-8 bg-indigo-600 rounded-full"></div>
                <h2 class="text-xl font-bold text-slate-800">Генератор заданий</h2>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Сложность (Класс)</label>
                    <div class="grid grid-cols-3 gap-2 mt-1">
                        <button class="diff-btn p-3 border-2 border-slate-100 rounded-xl text-sm font-bold transition-all active" data-val="1-3">1-3 кл</button>
                        <button class="diff-btn p-3 border-2 border-slate-100 rounded-xl text-sm font-bold transition-all" data-val="4-5">4-5 кл</button>
                        <button class="diff-btn p-3 border-2 border-slate-100 rounded-xl text-sm font-bold transition-all" data-val="6-9">6-9 кл</button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Предмет</label>
                    <select id="p-subject" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-400 transition-all mt-1">
                        <!-- Динамический список -->
                    </select>
                </div>

                <div id="other-subject-container" class="hidden animate-pulse">
                    <label class="text-[10px] font-bold text-indigo-500 uppercase ml-1">Своя тема (ИИ сгенерирует по ней)</label>
                    <input type="text" id="p-subject-other" placeholder="Напр: Столицы мира или Умножение на 7" class="w-full p-4 bg-white border-2 border-indigo-200 rounded-xl outline-none focus:border-indigo-600 transition-all mt-1">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Количество задач: <span id="p-count-val" class="text-indigo-600">3</span></label>
                    <input type="range" id="p-count" min="1" max="10" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600 mt-2">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Ключ доступа (результат)</label>
                    <input type="text" id="p-code" placeholder="Напр: 2026" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-xl font-bold text-center outline-none focus:border-indigo-400 transition-all mt-1">
                </div>
            </div>
            
            <button id="btn-send-task" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane"></i> ОТПРАВИТЬ РЕБЕНКУ
            </button>
            <p id="p-status" class="text-center text-xs font-bold"></p>
        </div>

        <!-- SETUP РЕБЕНКА -->
        <div id="view-child-setup" class="view-section space-y-4">
            <h2 class="text-xl font-bold">Подключение</h2>
            <input type="text" id="input-family-id" placeholder="ID РОДИТЕЛЯ" class="w-full p-5 bg-slate-100 rounded-2xl uppercase text-center font-black tracking-widest text-2xl outline-none border-4 border-transparent focus:border-orange-400 transition-all">
            <button id="btn-link-child" class="w-full bg-orange-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-orange-100 active:scale-95 transition-all">ПОДКЛЮЧИТЬСЯ</button>
        </div>

        <!-- DASHBOARD РЕБЕНКА -->
        <div id="view-child-dash" class="view-section h-full justify-center text-center">
            <div id="no-task" class="space-y-4">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-300">
                    <i class="fas fa-hourglass-half text-3xl"></i>
                </div>
                <p class="text-slate-400 font-medium">Ждем задание от родителей...</p>
            </div>
            <div id="has-task" class="hidden space-y-6">
                <div class="p-8 bg-orange-50 rounded-[2.5rem] border-2 border-orange-100 relative overflow-hidden">
                    <div class="absolute -top-6 -right-6 w-20 h-20 bg-orange-200 rounded-full opacity-20"></div>
                    <p class="text-[10px] uppercase font-black text-orange-400 mb-2 tracking-widest">Новый вызов</p>
                    <h2 id="c-task-title" class="text-2xl font-black text-orange-800">...</h2>
                    <p id="c-task-info" class="text-sm text-orange-600 mt-2 font-bold"></p>
                </div>
                <button id="btn-start-solve" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-black text-lg shadow-2xl shadow-orange-200 active:scale-95 transition-all">ПРИНЯТЬ И РЕШИТЬ</button>
            </div>
        </div>

        <!-- ЭКРАН РЕШЕНИЯ -->
        <div id="view-solve" class="view-section h-full">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-2">
                    <div id="solve-loader" class="loader"></div>
                    <span id="step-counter" class="text-xs font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full">Загрузка...</span>
                </div>
                <div id="error-count" class="text-red-500 font-bold text-[10px] uppercase bg-red-50 px-3 py-1 rounded-full">Ошибки: 0/3</div>
            </div>
            <div id="q-area" class="flex-1 flex flex-col justify-center">
                <div class="bg-slate-900 text-white p-8 rounded-[2.5rem] text-center mb-8 shadow-2xl relative">
                    <i class="fas fa-quote-left absolute top-4 left-6 text-slate-700 text-2xl"></i>
                    <p id="q-text" class="text-lg leading-relaxed font-medium">Готовим ваш вопрос...</p>
                </div>
                <div id="options-grid" class="grid gap-3"></div>
            </div>
        </div>

        <!-- БЛОКИРОВКА -->
        <div id="view-lockout" class="view-section h-full justify-center text-center">
            <i class="fas fa-lock text-6xl text-red-500 mb-6"></i>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ДОСТУП ОГРАНИЧЕН</h2>
            <div id="timer-display" class="text-5xl font-mono font-black text-red-600 mb-6">10:00</div>
            <p class="text-sm text-slate-500 px-8 leading-relaxed">Слишком много ошибок. Мозг должен отдохнуть 10 минут перед следующей попыткой.</p>
        </div>

        <!-- ФИНАЛ -->
        <div id="view-final-code" class="view-section h-full justify-center text-center">
            <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
                <i class="fas fa-trophy text-4xl"></i>
            </div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">УСПЕХ!</h2>
            <p class="text-slate-500 mb-8">Ты молодец! Твой ключ доступа:</p>
            <div class="p-10 bg-indigo-600 text-white rounded-[3rem] text-5xl font-black tracking-[0.2em] shadow-2xl shadow-indigo-300 relative" id="final-key">
                ----
                <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-yellow-400 rounded-full border-4 border-white"></div>
            </div>
            <button id="btn-finish" class="mt-12 text-slate-400 font-bold hover:text-indigo-600 transition-colors">ЗАВЕРШИТЬ</button>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIQjy3dFSGd9QGgV4BatCzdJTmdZ0iZi4",
        authDomain: "mesenger-12877.firebaseapp.com",
        projectId: "mesenger-12877",
        storageBucket: "mesenger-12877.firebasestorage.app",
        messagingSenderId: "1092702050769",
        appId: "1:1092702050769:web:43339478e22b80d5c368f0",
        measurementId: "G-XG5906V6G2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "smartkey-gh-deployment";

    // AI SETTINGS (OPENROUTER) - Switched to Gemini Flash for better reliability
    const OPENROUTER_API_KEY = "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";
    const AI_MODEL = "google/gemini-2.0-flash-exp:free";

    let familyId = localStorage.getItem('sk_family_id');
    let userRole = localStorage.getItem('sk_role');
    let activeTask = null;
    let currentStep = 0;
    let errorCount = 0;
    let selectedDiff = "1-3";

    const subjectsByDiff = {
        "1-3": ["Математика", "Русский язык", "Окружающий мир", "Логика", "Другое"],
        "4-5": ["Математика", "Русский язык", "Литература", "Английский язык", "Логика", "Другое"],
        "6-9": ["Алгебра", "Геометрия", "Физика", "Биология", "История", "География", "Другое"]
    };

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        const el = document.getElementById(`view-${id}`);
        if(el) el.classList.add('active');
    }

    const safeSignIn = async (retries = 3) => {
        for(let i=0; i<retries; i++){
            try { return await signInAnonymously(auth); } catch(e) { 
                if(i === retries-1) document.getElementById('auth-error-msg').classList.remove('hidden');
                await new Promise(r => setTimeout(r, 1000));
            }
        }
    };

    function updateSubjects() {
        const select = document.getElementById('p-subject');
        if(!select) return;
        select.innerHTML = '';
        subjectsByDiff[selectedDiff].forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.innerText = s;
            select.appendChild(opt);
        });
        checkOtherField();
    }

    function checkOtherField() {
        const pSub = document.getElementById('p-subject');
        if(!pSub) return;
        const isOther = pSub.value === "Другое";
        document.getElementById('other-subject-container').style.display = isOther ? "block" : "none";
    }

    // Обработчики кнопок сложности с подсветкой
    document.querySelectorAll('.diff-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedDiff = btn.dataset.val;
            updateSubjects();
        }
    });

    const pSub = document.getElementById('p-subject');
    if(pSub) pSub.onchange = checkOtherField;
    
    const pCount = document.getElementById('p-count');
    if(pCount) pCount.oninput = (e) => document.getElementById('p-count-val').innerText = e.target.value;

    const selectRole = async (role) => {
        userRole = role;
        localStorage.setItem('sk_role', role);
        await safeSignIn();
        if (role === 'parent') {
            if (!familyId) {
                familyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                localStorage.setItem('sk_family_id', familyId);
            }
            document.getElementById('display-family-id').innerText = familyId;
            updateBadge();
            switchView('parent-setup');
            updateSubjects();
        } else {
            switchView('child-setup');
        }
    };

    function updateBadge() {
        if (familyId) {
            const b = document.getElementById('family-badge');
            b.innerText = `ID: ${familyId}`;
            b.classList.remove('hidden');
        }
    }

    document.getElementById('btn-role-parent').onclick = () => selectRole('parent');
    document.getElementById('btn-role-child').onclick = () => selectRole('child');
    document.getElementById('btn-parent-go').onclick = () => switchView('parent-dash');
    document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };
    
    document.getElementById('btn-link-child').onclick = async () => {
        const val = document.getElementById('input-family-id').value.toUpperCase().trim();
        if (val.length < 3) return;
        familyId = val;
        localStorage.setItem('sk_family_id', familyId);
        await safeSignIn();
        updateBadge();
        switchView('child-dash');
        listenForTasks();
    };

    document.getElementById('btn-send-task').onclick = async () => {
        if (!familyId) return;
        const sub = document.getElementById('p-subject').value;
        const other = document.getElementById('p-subject-other').value;
        const data = {
            subject: sub === "Другое" ? `Другое (${other})` : sub,
            real_subject: sub === "Другое" ? other : sub,
            difficulty: selectedDiff,
            count: parseInt(document.getElementById('p-count').value),
            code: document.getElementById('p-code').value || "1234",
            ts: Date.now()
        };
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), data);
            document.getElementById('p-status').innerText = "✅ ЗАДАНИЕ ОТПРАВЛЕНО";
            setTimeout(() => document.getElementById('p-status').innerText = "", 3000);
        } catch(e) { document.getElementById('p-status').innerText = "❌ Ошибка БД"; }
    };

    document.getElementById('btn-start-solve').onclick = () => {
        currentStep = 0; errorCount = 0;
        switchView('solve');
        loadAIQuestion();
    };

    function listenForTasks() {
        if(!familyId) return;
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), (snap) => {
            if (snap.exists()) {
                activeTask = snap.data();
                document.getElementById('no-task').classList.add('hidden');
                document.getElementById('has-task').classList.remove('hidden');
                document.getElementById('c-task-title').innerText = activeTask.subject;
                document.getElementById('c-task-info').innerText = `${activeTask.count} задач • Класс ${activeTask.difficulty}`;
            } else {
                document.getElementById('no-task').classList.remove('hidden');
                document.getElementById('has-task').classList.add('hidden');
            }
        });
    }

    async function fetchWithRetry(url, options, maxRetries = 3) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) return await response.json();
                if (response.status === 429 || response.status >= 500) {
                    await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    continue;
                }
                throw new Error(`HTTP ${response.status}`);
            } catch (err) {
                if (i === maxRetries - 1) throw err;
                await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
            }
        }
    }

    async function loadAIQuestion() {
        const loader = document.getElementById('solve-loader');
        loader.classList.remove('hidden');
        document.getElementById('step-counter').innerText = `Вопрос ${currentStep + 1}/${activeTask.count}`;
        
        const prompt = `Сгенерируй ОДИН школьный вопрос с вариантами ответов.
        Предмет: ${activeTask.real_subject}
        Уровень сложности: ${activeTask.difficulty} класс
        Язык: Русский
        Правила:
        1. Один из вариантов ДОЛЖЕН в точности совпадать с полем "a".
        2. Формат строго JSON.
        JSON: {"q": "Текст вопроса", "opts": ["вариант1", "вариант2", "вариант3", "вариант4"], "a": "правильный вариант"}`;

        try {
            const data = await fetchWithRetry("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: AI_MODEL,
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.7
                })
            });

            let content = data.choices[0].message.content.trim();
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) content = jsonMatch[0];
            
            const task = JSON.parse(content);
            if (!task.q || !task.opts || !task.a) throw new Error("Format missing");
            renderTask(task);
        } catch (e) {
            console.error("AI Error:", e);
            const a = Math.floor(Math.random()*10);
            const b = Math.floor(Math.random()*10);
            const fallback = { 
                q: `Сколько будет ${a} + ${b}?`, 
                opts: [`${a+b}`, `${a+b+1}`, `${a+b-1}`, `${a*b}`], 
                a: `${a+b}` 
            };
            renderTask(fallback);
        } finally { loader.classList.add('hidden'); }
    }

    function renderTask(task) {
        document.getElementById('q-text').innerText = task.q;
        document.getElementById('error-count').innerText = `Ошибки: ${errorCount}/3`;
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        task.opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = "w-full p-4 bg-slate-100 rounded-2xl font-bold hover:bg-indigo-50 border-2 border-transparent hover:border-indigo-200 transition-all text-slate-700";
            b.innerText = opt;
            b.onclick = () => {
                // Улучшенная логика сравнения (без учета пробелов и регистра)
                const normalizedAnswer = String(task.a).trim().toLowerCase();
                const normalizedUserChoice = String(opt).trim().toLowerCase();
                
                if (normalizedUserChoice === normalizedAnswer) {
                    currentStep++;
                    if (currentStep >= activeTask.count) {
                        document.getElementById('final-key').innerText = activeTask.code;
                        switchView('final-code');
                    } else loadAIQuestion();
                } else {
                    errorCount++;
                    if (errorCount >= 3) {
                        switchView('lockout');
                        startLockoutTimer();
                    } else {
                        document.getElementById('error-count').innerText = `Ошибки: ${errorCount}/3`;
                        // Подсветка неверного выбора и загрузка нового вопроса
                        b.classList.replace('bg-slate-100', 'bg-red-100');
                        b.classList.add('text-red-700');
                        setTimeout(() => loadAIQuestion(), 600);
                    }
                }
            };
            grid.appendChild(b);
        });
    }

    function startLockoutTimer() {
        let left = 600;
        const display = document.getElementById('timer-display');
        const it = setInterval(() => {
            left--;
            const m = Math.floor(left/60), s = left%60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (left <= 0) { clearInterval(it); switchView('child-dash'); }
        }, 1000);
    }

    document.getElementById('btn-finish').onclick = async () => {
        try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId)); } catch (e) {}
        location.reload();
    };

    window.onload = async () => {
        if (familyId && userRole) {
            updateBadge();
            await safeSignIn();
            if (userRole === 'parent') {
                const disp = document.getElementById('display-family-id');
                if(disp) disp.innerText = familyId;
                switchView('parent-dash');
                // Подсвечиваем дефолтную кнопку сложности при загрузке
                document.querySelector(`.diff-btn[data-val="${selectedDiff}"]`)?.classList.add('active');
                updateSubjects();
            } else {
                switchView('child-dash');
                listenForTasks();
            }
        }
    };
</script>
</body>
</html>
