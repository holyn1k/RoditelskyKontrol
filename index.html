<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartKey - Система Контроля</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .app-container { max-width: 450px; margin: 0 auto; min-height: 100vh; background: white; display: flex; flex-col; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.1); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Header -->
    <header class="w-full p-5 bg-indigo-700 text-white flex justify-between items-center shadow-lg">
        <div class="flex items-center gap-2">
            <i class="fas fa-shield-alt text-xl"></i>
            <h1 class="font-extrabold tracking-tight">SMARTKEY</h1>
        </div>
        <div id="status-tag" class="text-[10px] bg-indigo-800 px-2 py-1 rounded border border-indigo-500">OFFLINE</div>
    </header>

    <main class="flex-1 p-6 overflow-y-auto">
        
        <!-- ЭКРАН ВЫБОРА РОЛИ -->
        <div id="view-start" class="h-full flex flex-col justify-center space-y-4 fade-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-gray-800">Режим работы</h2>
                <p class="text-gray-500 text-sm">Выберите тип устройства для синхронизации</p>
            </div>
            <button onclick="setRole('parent')" class="w-full p-6 border-2 border-indigo-100 rounded-2xl flex items-center gap-4 hover:bg-indigo-50 transition">
                <div class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white"><i class="fas fa-lock"></i></div>
                <div class="text-left"><b class="block">Родитель</b><span class="text-xs text-gray-500">Управлять кодами и заданиями</span></div>
            </button>
            <button onclick="setRole('child')" class="w-full p-6 border-2 border-emerald-100 rounded-2xl flex items-center gap-4 hover:bg-emerald-50 transition">
                <div class="w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center text-white"><i class="fas fa-user-graduate"></i></div>
                <div class="text-left"><b class="block">Ребенок</b><span class="text-xs text-gray-500">Решать задачи для доступа</span></div>
            </button>
        </div>

        <!-- РОДИТЕЛЬСКИЙ ИНТЕРФЕЙС -->
        <div id="view-parent" class="hidden fade-in space-y-6">
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Настройка обучения</label>
                <div class="space-y-3">
                    <input type="text" id="p-subject" placeholder="Предмет (напр. Русский язык)" class="w-full p-3 rounded-lg border border-gray-300 outline-none focus:border-indigo-500">
                    <select id="p-grade" class="w-full p-3 rounded-lg border border-gray-300 outline-none">
                        <option value="1">1 класс</option>
                        <option value="5">5 класс</option>
                        <option value="9">9 класс</option>
                        <option value="11">11 класс</option>
                    </select>
                </div>
            </div>

            <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <label class="block text-xs font-bold text-indigo-400 uppercase mb-2">Ключ разблокировки</label>
                <input type="text" id="p-code" placeholder="Введите код из Family Link" class="w-full p-4 text-2xl text-center font-mono font-bold rounded-lg border-2 border-indigo-200 outline-none focus:border-indigo-500">
            </div>

            <button onclick="syncToCloud()" id="btn-sync" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-xl active:scale-95 transition">
                ОТПРАВИТЬ РЕБЕНКУ
            </button>
            <p id="p-info" class="text-center text-xs text-gray-400">Данные будут обновлены на устройстве ребенка мгновенно</p>
        </div>

        <!-- ДЕТСКИЙ ИНТЕРФЕЙС -->
        <div id="view-child" class="hidden fade-in h-full flex flex-col">
            <div id="child-waiting" class="my-auto text-center space-y-4">
                <i class="fas fa-wifi text-4xl text-gray-200 animate-pulse"></i>
                <h3 class="font-bold text-gray-400">Ожидание задания от родителя...</h3>
            </div>

            <div id="child-task-ready" class="hidden my-auto space-y-8 animate-bounce">
                <div class="text-center">
                    <h2 class="text-3xl font-black text-gray-800">ЗАДАНИЕ ГОТОВО</h2>
                    <p id="c-task-info" class="text-indigo-600 font-bold uppercase tracking-widest text-sm mt-2">ПРЕДМЕТ: ...</p>
                </div>
                <button onclick="startSession()" class="w-full bg-indigo-600 text-white py-6 rounded-3xl font-black text-xl shadow-2xl">
                    РЕШИТЬ И ПОЛУЧИТЬ КОД
                </button>
            </div>
        </div>

        <!-- ЭКРАН РЕШЕНИЯ -->
        <div id="view-solve" class="hidden fade-in flex flex-col h-full">
            <div class="flex justify-between items-center mb-6">
                <span id="solve-title" class="text-xs font-bold text-indigo-400 uppercase">...</span>
                <div class="flex gap-1" id="dots">
                    <div class="w-2 h-2 rounded-full bg-gray-200"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-200"></div>
                    <div class="w-2 h-2 rounded-full bg-gray-200"></div>
                </div>
            </div>

            <div id="ai-loading" class="flex-1 flex flex-col items-center justify-center text-center hidden">
                <div class="loader mb-4"></div>
                <p class="text-gray-500 animate-pulse">ИИ генерирует сложную задачу...</p>
            </div>

            <div id="question-card" class="flex-1 flex flex-col justify-center space-y-6">
                <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl min-h-[150px] flex items-center justify-center text-center italic">
                    <p id="q-text" class="text-lg font-medium leading-relaxed">...</p>
                </div>
                <div id="options" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>

        <!-- ЭКРАН РЕЗУЛЬТАТА -->
        <div id="view-result" class="hidden fade-in h-full flex flex-col items-center justify-center text-center space-y-6">
            <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center text-white text-4xl shadow-2xl">
                <i class="fas fa-check-double"></i>
            </div>
            <div>
                <h2 class="text-3xl font-black text-gray-800">ДОСТУП ОТКРЫТ</h2>
                <p class="text-gray-500">Введи этот код в поле блокировки:</p>
            </div>
            <div class="w-full p-8 bg-gray-100 rounded-3xl border-4 border-white shadow-inner">
                <span id="final-code" class="text-5xl font-black tracking-widest text-indigo-700">----</span>
            </div>
            <button onclick="location.reload()" class="text-gray-400 text-xs font-bold uppercase tracking-tighter">Закрыть</button>
        </div>

    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Инициализация Firebase
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smartkey-v2';

    // Конфиг ИИ
    const API_KEY = "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";
    const MODEL = "arcee-ai/trinity-large-preview:free";

    let state = {
        role: null,
        currentTask: null,
        step: 0,
        correct: ""
    };

    // Глобальные функции для HTML
    window.setRole = async (role) => {
        state.role = role;
        document.getElementById('view-start').classList.add('hidden');
        await signInAnonymously(auth);
        
        if(role === 'parent') {
            document.getElementById('view-parent').classList.remove('hidden');
            document.getElementById('status-tag').innerText = "PARENT MODE";
        } else {
            document.getElementById('view-child').classList.remove('hidden');
            document.getElementById('status-tag').innerText = "CHILD MODE";
            startSyncListener();
        }
    };

    // РОДИТЕЛЬ: Отправка в облако
    window.syncToCloud = async () => {
        const btn = document.getElementById('btn-sync');
        const subject = document.getElementById('p-subject').value;
        const grade = document.getElementById('p-grade').value;
        const code = document.getElementById('p-code').value;

        if(!subject || !code) return alert("Заполните все поля!");

        btn.disabled = true;
        btn.innerText = "СИНХРОНИЗАЦИЯ...";

        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'sync'), {
                subject, grade, code, ts: Date.now()
            });
            alert("Задание отправлено ребенку!");
        } catch(e) {
            alert("Ошибка сети");
        } finally {
            btn.disabled = false;
            btn.innerText = "ОТПРАВИТЬ РЕБЕНКУ";
        }
    };

    // РЕБЕНОК: Слушатель облака
    function startSyncListener() {
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'sync'), (snap) => {
            if(snap.exists()) {
                state.currentTask = snap.data();
                document.getElementById('child-waiting').classList.add('hidden');
                document.getElementById('child-task-ready').classList.remove('hidden');
                document.getElementById('c-task-info').innerText = `ПРЕДМЕТ: ${state.currentTask.subject}`;
            }
        });
    }

    // РЕБЕНОК: Начало решения
    window.startSession = () => {
        state.step = 0;
        document.getElementById('view-child').classList.add('hidden');
        document.getElementById('view-solve').classList.remove('hidden');
        document.getElementById('solve-title').innerText = state.currentTask.subject;
        loadAIQuestion();
    };

    async function loadAIQuestion() {
        const loader = document.getElementById('ai-loading');
        const card = document.getElementById('question-card');
        loader.classList.remove('hidden');
        card.classList.add('hidden');

        // Обновляем точки
        const dots = document.getElementById('dots').children;
        for(let i=0; i<3; i++) dots[i].className = i < state.step ? "w-2 h-2 rounded-full bg-indigo-600" : "w-2 h-2 rounded-full bg-gray-200";

        const prompt = `Ты учитель экспертного уровня. Создай ОДНУ ОЧЕНЬ СЛОЖНУЮ задачу для учащегося ${state.currentTask.grade} класса по предмету "${state.currentTask.subject}". 
        Задача должна быть уровня олимпиады или профильного экзамена. 
        Ответ верни СТРОГО в JSON без лишнего текста: {"q": "текст задачи", "opts": ["вариант1", "вариант2", "вариант3", "вариант4"], "a": "правильный текст"}.
        Язык: Русский.`;

        try {
            const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: MODEL, messages: [{role: "user", content: prompt}] })
            });
            const data = await res.json();
            const task = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, ""));
            
            renderQuestion(task);
        } catch(e) {
            // Фолбэк если ИИ тупит
            renderQuestion({
                q: `Сложный вопрос по теме ${state.currentTask.subject}. Выберите наиболее точное определение или решите уравнение повышенной сложности.`,
                opts: ["Вариант А (Верный)", "Вариант Б", "Вариант В", "Вариант Г"],
                a: "Вариант А (Верный)"
            });
        } finally {
            loader.classList.add('hidden');
            card.classList.remove('hidden');
        }
    }

    function renderQuestion(task) {
        state.correct = task.a;
        document.getElementById('q-text').innerText = task.q;
        const optCont = document.getElementById('options');
        optCont.innerHTML = '';

        task.opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = "w-full p-4 bg-white border-2 border-gray-100 rounded-xl font-semibold text-gray-700 hover:border-indigo-500 transition active:scale-95 text-sm shadow-sm";
            b.innerText = opt;
            b.onclick = () => {
                if(opt === state.correct) {
                    b.classList.add('bg-indigo-600', 'text-white', 'border-indigo-700');
                    setTimeout(() => {
                        state.step++;
                        if(state.step >= 3) {
                            showReward();
                        } else {
                            loadAIQuestion();
                        }
                    }, 500);
                } else {
                    b.classList.add('bg-red-500', 'text-white', 'border-red-600');
                    if(navigator.vibrate) navigator.vibrate(200);
                    setTimeout(() => b.className = "w-full p-4 bg-white border-2 border-gray-100 rounded-xl font-semibold text-gray-700 shadow-sm", 1000);
                }
            };
            optCont.appendChild(b);
        });
    }

    function showReward() {
        document.getElementById('view-solve').classList.add('hidden');
        document.getElementById('view-result').classList.remove('hidden');
        document.getElementById('final-code').innerText = state.currentTask.code;
    }

</script>
</body>
                </html>
