<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartKey: Family Access</title>
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключение иконок -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Скрытие всех экранов по умолчанию, чтобы не было "каши" как на скрине */
        .view-section { display: none; }
        .view-section.active { display: flex; }
        #view-parent-dash.active, #view-parent-setup.active, #view-child-setup.active { display: block; }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
    
    <!-- HEADER -->
    <header class="p-4 flex justify-between items-center border-b bg-white z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-key"></i>
            </div>
            <h1 class="font-extrabold text-indigo-900 tracking-tight uppercase">SmartKey</h1>
        </div>
        <div class="flex items-center gap-2">
            <div id="family-badge" class="hidden text-[10px] font-bold px-2 py-1 rounded bg-indigo-100 text-indigo-700 uppercase"></div>
            <button onclick="logout()" class="text-slate-300 hover:text-red-500 transition-colors"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="flex-1 relative overflow-y-auto p-6">
        
        <!-- 1. ВЫБОР РОЛИ -->
        <div id="view-role-selection" class="view-section active h-full flex-col justify-center gap-6 fade-in">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-slate-800">Добро пожаловать</h2>
                <p class="text-slate-500">Выберите вашу роль</p>
            </div>
            <button onclick="selectRole('parent')" class="w-full p-6 border-2 border-indigo-100 rounded-3xl hover:border-indigo-500 hover:bg-indigo-50 transition-all flex items-center gap-5 group text-left mb-4">
                <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-indigo-600 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                    <i class="fas fa-user-shield text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800">Я родитель</h3>
                    <p class="text-xs text-slate-500">Управлять кодами доступа</p>
                </div>
            </button>
            <button onclick="selectRole('child')" class="w-full p-6 border-2 border-orange-100 rounded-3xl hover:border-orange-500 hover:bg-orange-50 transition-all flex items-center gap-5 group text-left">
                <div class="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                    <i class="fas fa-child text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-slate-800">Я ребенок</h3>
                    <p class="text-xs text-slate-500">Решать задачи</p>
                </div>
            </button>
        </div>

        <!-- 2. НАСТРОЙКА РОДИТЕЛЯ -->
        <div id="view-parent-setup" class="view-section fade-in space-y-6">
            <h2 class="text-2xl font-black text-slate-800">Создание группы</h2>
            <div class="p-6 bg-indigo-50 rounded-3xl border border-indigo-100 text-center">
                <p class="text-sm text-indigo-800 font-semibold mb-2 text-left">Ваш Семейный ID:</p>
                <div class="flex items-center justify-center gap-3">
                    <span id="display-family-id" class="text-3xl font-mono font-black tracking-widest text-indigo-600">......</span>
                    <button onclick="copyFamilyId()" class="p-2 text-indigo-400 hover:text-indigo-600"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <button onclick="goToParentDash()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold shadow-lg">ПЕРЕЙТИ В ПАНЕЛЬ</button>
        </div>

        <!-- 3. ПРИВЯЗКА РЕБЕНКА -->
        <div id="view-child-setup" class="view-section fade-in space-y-6">
            <h2 class="text-2xl font-black text-slate-800">Подключение</h2>
            <input type="text" id="input-family-id" placeholder="ID РОДИТЕЛЯ" class="w-full p-5 bg-slate-100 border-none rounded-2xl font-bold text-slate-700 uppercase tracking-widest text-center outline-none focus:ring-2 focus:ring-orange-500">
            <button onclick="linkChildToFamily()" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-bold shadow-lg">ПОДКЛЮЧИТЬСЯ</button>
        </div>

        <!-- 4. ПАНЕЛЬ РОДИТЕЛЯ -->
        <div id="view-parent-dash" class="view-section fade-in space-y-6">
            <div class="bg-indigo-900 text-white p-6 rounded-3xl shadow-xl flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-lg font-bold">Управление</h2>
                    <p class="text-indigo-300 text-[10px] uppercase font-bold tracking-wider">Облачная синхронизация</p>
                </div>
                <i class="fas fa-cloud text-indigo-400"></i>
            </div>
            <div class="space-y-4">
                <input type="text" id="p-subject" placeholder="Предмет (напр: Математика)" class="w-full p-4 bg-slate-100 border-none rounded-2xl font-bold text-slate-700 outline-none">
                <input type="text" id="p-grade" placeholder="Уровень (напр: 3 класс)" class="w-full p-4 bg-slate-100 border-none rounded-2xl font-bold text-slate-700 outline-none">
                <input type="text" id="p-code" placeholder="КЛЮЧ ДОСТУПА ДЛЯ РЕБЕНКА" class="w-full p-4 bg-slate-100 border-none rounded-2xl font-bold text-indigo-600 outline-none border-2 border-indigo-100">
            </div>
            <button id="send-btn" onclick="sendTaskToCloud()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-extrabold shadow-lg mt-4">ОТПРАВИТЬ ЗАДАНИЕ</button>
            <p id="p-status" class="text-center text-xs text-slate-400 h-4 mt-2"></p>
        </div>

        <!-- 5. ПАНЕЛЬ РЕБЕНКА -->
        <div id="view-child-dash" class="view-section fade-in h-full flex-col text-center">
            <div id="no-task" class="my-auto space-y-4">
                <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto text-indigo-300 animate-pulse">
                    <i class="fas fa-satellite-dish text-2xl"></i>
                </div>
                <h3 class="font-bold text-slate-800">Ждем задание...</h3>
            </div>
            <div id="has-task" class="hidden space-y-6 my-auto w-full">
                <div class="p-8 bg-orange-50 rounded-3xl border-2 border-orange-100">
                    <h2 id="c-task-title" class="text-2xl font-black text-slate-800">...</h2>
                    <p id="c-task-grade" class="text-slate-500 text-xs mt-2 font-bold uppercase"></p>
                </div>
                <button onclick="startSolving()" class="w-full bg-orange-500 text-white py-5 rounded-2xl font-extrabold shadow-xl">НАЧАТЬ РЕШЕНИЕ</button>
            </div>
        </div>

        <!-- 6. ЭКРАН РЕШЕНИЯ -->
        <div id="view-solve" class="view-section fade-in flex-col h-full">
            <div class="flex justify-between items-center mb-8">
                <div id="solve-loader" class="loader hidden"></div>
                <div class="flex flex-col items-end">
                    <div class="flex gap-2 mb-2" id="progress-dots">
                        <div class="w-3 h-3 rounded-full bg-slate-200"></div>
                        <div class="w-3 h-3 rounded-full bg-slate-200"></div>
                        <div class="w-3 h-3 rounded-full bg-slate-200"></div>
                    </div>
                    <div id="error-count" class="text-[10px] font-black text-red-500 uppercase">Ошибки: 0/3</div>
                </div>
            </div>
            <div id="question-box" class="flex-1 flex flex-col justify-center">
                <div class="bg-slate-900 text-white p-8 rounded-[40px] shadow-2xl mb-8 text-center">
                    <p id="q-text" class="text-lg font-bold leading-relaxed">...</p>
                </div>
                <div id="options-grid" class="grid grid-cols-1 gap-4"></div>
            </div>
        </div>

        <!-- 7. ЭКРАН БЛОКИРОВКИ -->
        <div id="view-lockout" class="view-section fade-in flex-col items-center justify-center h-full text-center">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-6">
                <i class="fas fa-hourglass-half text-2xl animate-bounce"></i>
            </div>
            <h2 class="text-xl font-black mb-2">ПОДУМАЙ 10 МИНУТ</h2>
            <div id="timer-display" class="text-4xl font-mono font-black mb-8">10:00</div>
            <button id="retry-btn" disabled onclick="restartAfterLockout()" class="w-full bg-slate-200 text-slate-400 py-5 rounded-2xl font-bold">ПОПРОБОВАТЬ СНОВА</button>
        </div>

        <!-- 8. ФИНАЛЬНЫЙ ЭКРАН -->
        <div id="view-final-code" class="view-section fade-in flex-col items-center justify-center h-full text-center">
            <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center text-white mb-6 animate-bounce">
                <i class="fas fa-check text-2xl"></i>
            </div>
            <h2 class="text-2xl font-black mb-2">ГОТОВО!</h2>
            <p class="text-slate-500 mb-8 text-sm">Твой ключ доступа:</p>
            <div class="p-10 bg-slate-900 rounded-[40px] w-full">
                <span id="final-key" class="text-5xl font-black tracking-widest text-indigo-400">----</span>
            </div>
            <button onclick="resetTask()" class="mt-8 text-slate-400 text-xs font-bold uppercase">Завершить</button>
        </div>

    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'smartkey-gh-fix';
    const AI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

    let familyId = localStorage.getItem('sk_family_id');
    let userRole = localStorage.getItem('sk_role');
    let activeTask = null;
    let solveStep = 0;
    let errorCount = 0;
    let lockoutTimer = null;

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(`view-${id}`);
        if (target) target.classList.add('active');
    }

    // Роли
    window.selectRole = async (role) => {
        userRole = role;
        localStorage.setItem('sk_role', role);
        await signInAnonymously(auth);
        
        if (role === 'parent') {
            if (!familyId) {
                familyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                localStorage.setItem('sk_family_id', familyId);
            }
            document.getElementById('display-family-id').innerText = familyId;
            switchView('parent-setup');
        } else {
            if (checkLockoutStatus()) { startLockoutTimer(); switchView('lockout'); }
            else { switchView('child-setup'); }
        }
    };

    window.goToParentDash = () => switchView('parent-dash');
    window.linkChildToFamily = () => {
        const val = document.getElementById('input-family-id').value.toUpperCase().trim();
        if (val.length < 3) return;
        familyId = val;
        localStorage.setItem('sk_family_id', familyId);
        switchView('child-dash');
        listenForTasks();
    };

    window.sendTaskToCloud = async () => {
        const data = {
            subject: document.getElementById('p-subject').value || "Математика",
            grade: document.getElementById('p-grade').value || "Общий",
            code: document.getElementById('p-code').value || "0000",
            ts: Date.now()
        };
        const status = document.getElementById('p-status');
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), data);
            status.innerText = "✅ Отправлено!";
            setTimeout(() => status.innerText = "", 2000);
        } catch (e) { status.innerText = "❌ Ошибка"; }
    };

    function listenForTasks() {
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), (snap) => {
            if (snap.exists()) {
                activeTask = snap.data();
                document.getElementById('no-task').classList.add('hidden');
                document.getElementById('has-task').classList.remove('hidden');
                document.getElementById('c-task-title').innerText = activeTask.subject;
                document.getElementById('c-task-grade').innerText = activeTask.grade;
            } else {
                document.getElementById('no-task').classList.remove('hidden');
                document.getElementById('has-task').classList.add('hidden');
            }
        });
    }

    // Решение
    window.startSolving = () => {
        solveStep = 0; errorCount = 0;
        updateErrorDisplay();
        switchView('solve');
        loadAIQuestion();
    };

    async function loadAIQuestion() {
        const loader = document.getElementById('solve-loader');
        loader.classList.remove('hidden');
        const prompt = `Generate 1 educational task (JSON) for ${activeTask.subject}, ${activeTask.grade}. Format: {"q":"question","opts":["a","b","c","d"],"a":"correct_val"}. Russian language.`;
        
        try {
            const res = await fetch(AI_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            const json = await res.json();
            const task = JSON.parse(json.candidates[0].content.parts[0].text);
            renderTask(task);
        } catch (e) {
            renderTask({q: "2 + 2 * 2", opts: ["4", "6", "8", "2"], a: "6"});
        } finally { loader.classList.add('hidden'); }
    }

    function renderTask(task) {
        document.getElementById('q-text').innerText = task.q;
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        const dots = document.getElementById('progress-dots').children;
        for(let i=0; i<3; i++) dots[i].className = i < solveStep ? "w-3 h-3 rounded-full bg-indigo-500" : "w-3 h-3 rounded-full bg-slate-200";

        task.opts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "w-full p-5 bg-white border-2 border-slate-100 rounded-2xl font-bold text-slate-700 hover:border-indigo-500 transition";
            btn.innerText = opt;
            btn.onclick = () => {
                if (opt === task.a) {
                    solveStep++;
                    if (solveStep >= 3) {
                        document.getElementById('final-key').innerText = activeTask.code;
                        switchView('final-code');
                    } else loadAIQuestion();
                } else {
                    errorCount++;
                    updateErrorDisplay();
                    if (errorCount >= 3) setLockout();
                    else loadAIQuestion(); // Сразу новая задача при ошибке
                }
            };
            grid.appendChild(btn);
        });
    }

    function updateErrorDisplay() {
        document.getElementById('error-count').innerText = `Ошибки: ${errorCount}/3`;
    }

    function setLockout() {
        const end = Date.now() + (10 * 60 * 1000);
        localStorage.setItem('sk_lockout', end);
        startLockoutTimer();
        switchView('lockout');
    }

    function checkLockoutStatus() {
        const lock = localStorage.getItem('sk_lockout');
        return lock && Date.now() < parseInt(lock);
    }

    function startLockoutTimer() {
        if (lockoutTimer) clearInterval(lockoutTimer);
        lockoutTimer = setInterval(() => {
            const diff = parseInt(localStorage.getItem('sk_lockout')) - Date.now();
            if (diff <= 0) {
                clearInterval(lockoutTimer);
                document.getElementById('timer-display').innerText = "00:00";
                const rb = document.getElementById('retry-btn');
                rb.disabled = false; rb.classList.replace('bg-slate-200', 'bg-indigo-600'); rb.classList.replace('text-slate-400', 'text-white');
                return;
            }
            const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
            document.getElementById('timer-display').innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
        }, 1000);
    }

    window.restartAfterLockout = () => { switchView('child-dash'); };
    window.resetTask = async () => { 
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId));
        switchView('child-dash'); 
    };
    window.logout = () => { localStorage.clear(); location.reload(); };

    // Авто-логин
    window.onload = async () => {
        if (familyId && userRole) {
            await signInAnonymously(auth);
            if (userRole === 'parent') {
                document.getElementById('display-family-id').innerText = familyId;
                switchView('parent-dash');
            } else {
                if (checkLockoutStatus()) { startLockoutTimer(); switchView('lockout'); }
                else { switchView('child-dash'); listenForTasks(); }
            }
        }
    };
</script>

</body>
</html>
