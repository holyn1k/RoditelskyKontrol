<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartKey: Family Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; margin: 0; }
        .view-section { display: none; flex-direction: column; }
        .view-section.active { display: flex; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative overflow-hidden">
    <header class="p-4 flex justify-between items-center border-b bg-white z-20">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fas fa-key"></i>
            </div>
            <h1 class="font-extrabold text-indigo-900 tracking-tight uppercase">SmartKey</h1>
        </div>
        <div class="flex items-center gap-2">
            <div id="family-badge" class="hidden text-[10px] font-bold px-2 py-1 rounded bg-indigo-100 text-indigo-700 uppercase"></div>
            <button id="logout-btn" class="text-slate-300 hover:text-red-500"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </header>

    <main class="flex-1 relative p-6">
        <!-- ВЫБОР РОЛИ -->
        <div id="view-role-selection" class="view-section active h-full justify-center gap-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-black text-slate-800">Кто зашел?</h2>
            </div>
            <button id="btn-role-parent" class="w-full p-6 border-2 border-indigo-100 rounded-3xl hover:border-indigo-500 flex items-center gap-4 text-left">
                <div class="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600"><i class="fas fa-user-shield"></i></div>
                <div><b class="block">Я родитель</b><span class="text-xs text-slate-500">Создать задание</span></div>
            </button>
            <button id="btn-role-child" class="w-full p-6 border-2 border-orange-100 rounded-3xl hover:border-orange-500 flex items-center gap-4 text-left">
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-orange-600"><i class="fas fa-child"></i></div>
                <div><b class="block">Я ребенок</b><span class="text-xs text-slate-500">Решить и войти</span></div>
            </button>
        </div>

        <!-- НАСТРОЙКА РОДИТЕЛЯ -->
        <div id="view-parent-setup" class="view-section space-y-6">
            <h2 class="text-xl font-bold">Ваш Семейный ID</h2>
            <div class="p-6 bg-indigo-50 rounded-2xl text-center">
                <span id="display-family-id" class="text-3xl font-mono font-black text-indigo-600">......</span>
            </div>
            <button id="btn-parent-go" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">ДАЛЕЕ</button>
        </div>

        <!-- ПАНЕЛЬ РОДИТЕЛЯ -->
        <div id="view-parent-dash" class="view-section space-y-4">
            <div class="bg-slate-800 text-white p-4 rounded-2xl mb-4">Панель управления</div>
            <input type="text" id="p-subject" placeholder="Предмет" class="w-full p-4 bg-slate-100 rounded-xl outline-none">
            <input type="text" id="p-code" placeholder="КЛЮЧ ДОСТУПА (например: 5555)" class="w-full p-4 bg-indigo-50 border-2 border-indigo-200 rounded-xl font-bold outline-none">
            <button id="btn-send-task" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold">ОТПРАВИТЬ</button>
            <p id="p-status" class="text-center text-xs"></p>
        </div>

        <!-- ПРИВЯЗКА РЕБЕНКА -->
        <div id="view-child-setup" class="view-section space-y-4">
            <h2 class="text-xl font-bold">Подключение</h2>
            <input type="text" id="input-family-id" placeholder="ID РОДИТЕЛЯ" class="w-full p-4 bg-slate-100 rounded-xl uppercase text-center font-bold">
            <button id="btn-link-child" class="w-full bg-orange-500 text-white py-4 rounded-xl font-bold">ВОЙТИ</button>
        </div>

        <!-- ПАНЕЛЬ РЕБЕНКА -->
        <div id="view-child-dash" class="view-section h-full justify-center text-center">
            <div id="no-task" class="space-y-4">
                <i class="fas fa-clock text-4xl text-slate-200"></i>
                <p>Ждем задание от родителей...</p>
            </div>
            <div id="has-task" class="hidden space-y-6">
                <div class="p-6 bg-orange-50 rounded-2xl border-2 border-orange-100">
                    <h2 id="c-task-title" class="text-xl font-bold">...</h2>
                </div>
                <button id="btn-start-solve" class="w-full bg-orange-500 text-white py-4 rounded-xl font-bold">НАЧАТЬ ТЕСТ</button>
            </div>
        </div>

        <!-- ЭКРАН РЕШЕНИЯ -->
        <div id="view-solve" class="view-section h-full">
            <div class="flex justify-between items-center mb-6">
                <div id="solve-loader" class="loader hidden"></div>
                <div id="error-count" class="text-red-500 font-bold text-xs uppercase">Ошибки: 0/3</div>
            </div>
            <div id="q-area" class="flex-1">
                <div class="bg-slate-900 text-white p-6 rounded-3xl text-center mb-6">
                    <p id="q-text" class="text-lg">Загрузка вопроса...</p>
                </div>
                <div id="options-grid" class="grid gap-3"></div>
            </div>
        </div>

        <!-- БЛОКИРОВКА -->
        <div id="view-lockout" class="view-section h-full justify-center text-center">
            <h2 class="text-xl font-bold text-red-600 mb-4">БЛОКИРОВКА</h2>
            <div id="timer-display" class="text-5xl font-mono font-black mb-6">10:00</div>
            <p class="text-sm text-slate-500">Слишком много ошибок. Отдохни.</p>
        </div>

        <!-- ФИНАЛ -->
        <div id="view-final-code" class="view-section h-full justify-center text-center">
            <h2 class="text-2xl font-bold mb-4">ГОТОВО!</h2>
            <p class="mb-4">Твой ключ доступа:</p>
            <div class="p-8 bg-slate-900 text-indigo-400 rounded-3xl text-4xl font-black tracking-widest" id="final-key">----</div>
            <button id="btn-finish" class="mt-8 text-slate-400 underline">Завершить</button>
        </div>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // Использованы предоставленные пользователем данные конфигурации
    const firebaseConfig = {
        apiKey: "AIzaSyBIQjy3dFSGd9QGgV4BatCzdJTmdZ0iZi4",
        authDomain: "mesenger-12877.firebaseapp.com",
        projectId: "mesenger-12877",
        storageBucket: "mesenger-12877.firebasestorage.app",
        messagingSenderId: "1092702050769",
        appId: "1:1092702050769:web:43339478e22b80d5c368f0",
        measurementId: "G-XG5906V6G2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = "smartkey-gh-deployment";
    const AI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

    // В GitHub версии API ключ для Gemini обычно пустой, если он прокидывается через среду, 
    // но здесь мы оставляем заглушку. Если у вас есть свой ключ Gemini, вставьте его ниже.
    const geminiApiKey = ""; 

    let familyId = localStorage.getItem('sk_family_id');
    let userRole = localStorage.getItem('sk_role');
    let activeTask = null;
    let solveStep = 0;
    let errorCount = 0;

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        const el = document.getElementById(`view-${id}`);
        if(el) el.classList.add('active');
    }

    const selectRole = async (role) => {
        userRole = role;
        localStorage.setItem('sk_role', role);
        try {
            await signInAnonymously(auth);
            if (role === 'parent') {
                if (!familyId) {
                    familyId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    localStorage.setItem('sk_family_id', familyId);
                }
                document.getElementById('display-family-id').innerText = familyId;
                updateBadge();
                switchView('parent-setup');
            } else {
                switchView('child-setup');
            }
        } catch (e) {
            console.error("Auth error:", e);
        }
    };

    function updateBadge() {
        if (familyId) {
            const badge = document.getElementById('family-badge');
            badge.innerText = `ID: ${familyId}`;
            badge.classList.remove('hidden');
        }
    }

    // Привязка событий
    document.getElementById('btn-role-parent').onclick = () => selectRole('parent');
    document.getElementById('btn-role-child').onclick = () => selectRole('child');
    document.getElementById('btn-parent-go').onclick = () => switchView('parent-dash');
    document.getElementById('logout-btn').onclick = () => { localStorage.clear(); location.reload(); };
    
    document.getElementById('btn-link-child').onclick = async () => {
        const val = document.getElementById('input-family-id').value.toUpperCase().trim();
        if (val.length < 3) return;
        familyId = val;
        localStorage.setItem('sk_family_id', familyId);
        await signInAnonymously(auth);
        updateBadge();
        switchView('child-dash');
        listenForTasks();
    };

    document.getElementById('btn-send-task').onclick = async () => {
        if (!familyId) return;
        const data = {
            subject: document.getElementById('p-subject').value || "Математика",
            code: document.getElementById('p-code').value || "0000",
            ts: Date.now()
        };
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), data);
            document.getElementById('p-status').innerText = "✅ Отправлено";
        } catch (e) {
            document.getElementById('p-status').innerText = "❌ Ошибка доступа";
        }
    };

    document.getElementById('btn-start-solve').onclick = () => {
        solveStep = 0; errorCount = 0;
        switchView('solve');
        loadAIQuestion();
    };

    document.getElementById('btn-finish').onclick = async () => {
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId));
        } catch (e) {}
        switchView('child-dash');
    };

    function listenForTasks() {
        if(!familyId) return;
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'family_tasks', familyId), (snap) => {
            if (snap.exists()) {
                activeTask = snap.data();
                document.getElementById('no-task').classList.add('hidden');
                document.getElementById('has-task').classList.remove('hidden');
                document.getElementById('c-task-title').innerText = activeTask.subject;
            } else {
                document.getElementById('no-task').classList.remove('hidden');
                document.getElementById('has-task').classList.add('hidden');
            }
        }, (err) => console.error("Snapshot error:", err));
    }

    async function loadAIQuestion() {
        const loader = document.getElementById('solve-loader');
        loader.classList.remove('hidden');
        
        // Внимание: Здесь используется geminiApiKey. Если он пустой, сработает заглушка в catch.
        const url = `${AI_URL}${geminiApiKey}`;
        const prompt = `Generate 1 educational multiple-choice question about ${activeTask?.subject || 'General Knowledge'}. Return ONLY a JSON object: {"q":"question text","opts":["choice1","choice2","choice3","choice4"],"a":"correct choice text"}. Language: Russian.`;
        
        try {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
            });
            const json = await res.json();
            const task = JSON.parse(json.candidates[0].content.parts[0].text);
            renderTask(task);
        } catch (e) {
            // Заглушка, если API ключ не указан или ошибка
            const mockTasks = [
                {q: "Сколько будет 2 + 2 * 2?", opts: ["4", "6", "8", "10"], a: "6"},
                {q: "Столица Франции?", opts: ["Лондон", "Берлин", "Париж", "Рим"], a: "Париж"},
                {q: "Какая планета третья от Солнца?", opts: ["Марс", "Венера", "Земля", "Юпитер"], a: "Земля"}
            ];
            renderTask(mockTasks[Math.floor(Math.random() * mockTasks.length)]);
        } finally { loader.classList.add('hidden'); }
    }

    function renderTask(task) {
        document.getElementById('q-text').innerText = task.q;
        document.getElementById('error-count').innerText = `Ошибки: ${errorCount}/3`;
        const grid = document.getElementById('options-grid');
        grid.innerHTML = '';
        
        task.opts.forEach(opt => {
            const b = document.createElement('button');
            b.className = "w-full p-4 bg-slate-100 rounded-xl font-bold hover:bg-indigo-50 transition-colors";
            b.innerText = opt;
            b.onclick = () => {
                if (opt === task.a) {
                    solveStep++;
                    if (solveStep >= 3) {
                        document.getElementById('final-key').innerText = activeTask.code;
                        switchView('final-code');
                    } else loadAIQuestion();
                } else {
                    errorCount++;
                    if (errorCount >= 3) {
                        switchView('lockout');
                        startLockoutTimer();
                    }
                    else loadAIQuestion();
                }
            };
            grid.appendChild(b);
        });
    }

    function startLockoutTimer() {
        let timeLeft = 600; // 10 минут
        const display = document.getElementById('timer-display');
        const interval = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            display.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) {
                clearInterval(interval);
                switchView('child-dash');
            }
        }, 1000);
    }

    // Авто-вход
    window.onload = async () => {
        if (familyId && userRole) {
            updateBadge();
            try {
                await signInAnonymously(auth);
                if (userRole === 'parent') {
                    document.getElementById('display-family-id').innerText = familyId;
                    switchView('parent-dash');
                } else {
                    switchView('child-dash');
                    listenForTasks();
                }
            } catch (e) {
                console.error("Initial auth failed:", e);
                switchView('role-selection');
            }
        }
    };
</script>
</body>
</html>
